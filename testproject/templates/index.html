<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly Example</title>
    <script src="/static/wasm/lexi.js"></script>
</head>
<body>
    <h1>WebAssembly Example</h1>
    <p>Result of 5 + 7: <span id="result"></span></p>

    <script>
        class Lexi {
            constructor() {
                this.initModule()
                this.initTokenizer()
            }

            initModule = () => {
                // load wasm module
                createModule()
                .then(Module => {
                    this.module = Module
                }).catch(err => {
                    console.error( "Failed to load Lexi WASM module", err )
                })
            }

            ensureModuleLoaded = (callback) => {
                if ( this.module ) {
                    callback()
                } else {
                    // load wasm module
                    createModule()
                    .then(Module => {
                        this.module = Module
                        callback()
                    }).catch(err => {
                        console.error( "Failed to load Lexi WASM module", err )
                    })
                }
            }

            initTokenizer = () => {
                this.ensureModuleLoaded( () => {
                    this.tokenizer = this.module._initTokenizer()
                })
            }

            add = () => {
                this.ensureModuleLoaded( () => {
                    const result = this.module._add(5, 7);
                    document.getElementById('result').textContent = result;
                })
            }

            testStr = () => {
                this.ensureModuleLoaded( () => {
                    const processString = this.module.cwrap('testStr', 'const char*', ['number']);
    
                    // Allocate space in WebAssembly heap for the string
                    const str = "Hello from JavaScript!";
                    const len = this.module.lengthBytesUTF8(str) + 1; // Calculate string length in UTF-8 (plus null terminator)
                    const ptr = this.module._malloc(len); // Allocate memory

                    // Copy the string into the allocated memory
                    this.module.stringToUTF8(str, ptr, len);

                    // Call the C++ function
                    const result = processString(ptr);

                    console.log(this.module.UTF8ToString(result ))

                    // Free the memory
                    this.module._free(ptr);
                })
            }

            addRule = (name, expr) => {
                this.ensureModuleLoaded( () => {
                    const addRuleFunc = this.module.cwrap('addRule', 'void', ['number', 'number', 'number']);
    
                    // allocate name string
                    const nameLen = this.module.lengthBytesUTF8(name) + 1
                    const namePtr = this.module._malloc(nameLen)
                    this.module.stringToUTF8(name, namePtr, nameLen)

                    // allocate name string
                    const exprLen = this.module.lengthBytesUTF8(expr) + 1
                    const exprPtr = this.module._malloc(exprLen)
                    this.module.stringToUTF8(expr, exprPtr, exprLen)

                    addRuleFunc(this.tokenizer, namePtr, exprPtr)

                    // Free the memory
                    //this.module._free(ptr);
                })
            }

            tokenize = () => {
                this.ensureModuleLoaded( () => {
                    const tokenizeFunc = this.module.cwrap('tokenize', 'void', ['number']);
    
                    tokenizeFunc(this.tokenizer)

                    // Free the memory
                    //this.module._free(ptr);
                })
            }
        }

        const lexi = new Lexi()
        //lexi.addRule("STRING", "\"[a-zA-Z0-9\\s\\}]*\"")
        lexi.tokenize()
    </script>
</body>
</html>